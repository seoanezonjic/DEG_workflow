---
author: "James Richard Perkins"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    fig_width: 12
---

<style>
    body .main-container {
        max-width: 90%;
    }
</style>   

```{r prior_proc, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
	library(reshape2)
	library(ggplot2) 

	metric_table <- data[['metric_table']]
	metric_var_2_legend_name <- data.frame(
		metric_var = c("initial_total_sequences", "final_total_sequences", "Uniquely_mapped_reads_.", "multi_map", "X._of_reads_mapped_to_multiple_loci", "X._of_reads_mapped_to_too_many_loci", "X._of_reads_unmapped._too_short", "X._of_reads_unmapped._other", "Uniquely_mapped_reads_number", "aligned_to_feature", "initial_weigthed_qual_per_sequence", "number_duplicatedreads.estimated.", "final_mean_qual_per_base", "final_min_qual_per_base_in_10th_decile", "final_min_qual_per_base_in_lower_quartile", "final_weigthed_qual_per_sequence", "aligned_reads_percentage", "unaligned_reads_percentage", "multimapping_filtered_percentage", "aligned_reads", "filtered_reads"),
		legend_name = c("Total Reads Before Trimming", "Total Reads After Trimming", "Unique Map %", "Multi-mapping %", "Multi Map %", "Multi Map-too many %", "Unmapped: Too Short %", "Unmapped: Other %", "Unique Map", "Aligned to Genomic Feature", "Weighted Sequence Quality Before Trimming", "Estimated Duplicated Reads", "Average Base Quality", "Min Qual per Base (Tenth Decile)", "Min Qual per Base (Lower Quartile)", "Weighted Sequence Quality", "Aligned reads %", "Unaligned reads %", "Reads supressed by multimapping %", "Mapped reads", "Filtered reads")
	)

	make_stacked_barchart_from_df <- function(df, id, other_vars, legend_names=FALSE) {
		reduced_df <- df[,c(id, other_vars)]
		melt_df <- melt(reduced_df, id.vars = id)

		if(FALSE %in% legend_names & length(legend_names) == 1) {
			legend_names <- other_vars
		}

		g <- ggplot(melt_df, aes_string(x=id, y="value", fill="variable"))
		g + geom_bar(stat='identity') + theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
		scale_fill_discrete(labels = legend_names) +
		theme(legend.position="bottom", legend.title = element_blank())
	}

	make_stacked_barchart_from_df_dodge <- function(df, id, other_vars, legend_names=FALSE) {
		reduced_df <- df[,c(id, other_vars)]
		melt_df <- melt(reduced_df, id.vars = id)

		if(FALSE %in% legend_names & length(legend_names) == 1) {
			legend_names <- other_vars
		}
		g <- ggplot(melt_df, aes_string(x=id, y="value", fill="variable"))
		g + geom_bar(stat='identity', position=position_dodge()) + theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
		scale_fill_discrete(labels = legend_names) +
		theme(legend.position="bottom", legend.title = element_blank())
	}

	make_scatterplot_from_df <- function(df, var1, var2, axis_lab_name1=FALSE, axis_lab_name2=FALSE) {
		if(axis_lab_name1 == FALSE) axis_lab_name1 <- var1
		if(axis_lab_name2 == FALSE) axis_lab_name2 <- var2
		g <- ggplot(df, aes_string(x=var1, y=var2))
		g + geom_point() +
		theme(legend.position="bottom") +
		xlab(axis_lab_name1) + ylab(axis_lab_name2) + ylim(0,NA)
	}

	# this is a little like a barplot, but the absolute values are shown, with a line connecting them.
	make_vert_line_plot_from_df <- function(df, id, other_vars, legend_names=FALSE){
		reduced_df <- df[,c(id, other_vars)]
		melt_df <- melt(reduced_df, id.vars = id)

		if(FALSE %in% legend_names & length(legend_names) == 1) {
			legend_names <- other_vars
		}

		ggplot(melt_df, aes(x = sample, y = value, color = variable, group = variable)) + 
		theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
     	geom_point() + geom_line() + scale_color_discrete(labels=legend_names) +
		theme(legend.position="bottom", legend.title = element_blank())
	}

	###############################
	## CONTROL VARIABLES
	##############################
	vars_trimming <- c("initial_total_sequences", "final_total_sequences")
	execute_trimming <- all(vars_trimming %in% colnames(metric_table))
	vars_qual_scores <- c("final_min_qual_per_base_in_10th_decile", "final_min_qual_per_base_in_lower_quartile", "final_mean_qual_per_base", "final_weigthed_qual_per_sequence")
	execute_qual_scores <- all(vars_qual_scores %in% colnames(metric_table))
	vars_aligned_v_qual <- c("aligned_to_feature", "initial_weigthed_qual_per_sequence")
	execute_aligned_v_qual <- all(vars_aligned_v_qual %in% colnames(metric_table))
	vars_mapping <- c("Uniquely_mapped_reads_.", "X._of_reads_mapped_to_multiple_loci", "X._of_reads_mapped_to_too_many_loci", "X._of_reads_unmapped._too_short", "X._of_reads_unmapped._other")
	execute_mapping <- all(vars_mapping %in% colnames(metric_table))
	vars_feature_overlap <- c("final_total_sequences", "Uniquely_mapped_reads_number", "aligned_to_feature")
	execute_feature_overlap <- all(vars_feature_overlap %in% colnames(metric_table))
	vars_mirna_mapping <- c("aligned_reads_percentage", "unaligned_reads_percentage", "multimapping_filtered_percentage")
	execute_mirna_mapping <- all(vars_mirna_mapping %in% colnames(metric_table))
	vars_mirna_mapping_abs <- c("final_total_sequences", "filtered_reads", "aligned_reads")
	execute_mirna_mapping_abs <- all(vars_mirna_mapping_abs %in% colnames(metric_table))

	##############################
	## REPORT BEGINING
	##############################

	cat("# **QC and Alignment Report**\n\n")
```



```{r trimming, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_trimming}
	##################################################
	###	GLOBAL PLOTS
	##################################################

	cat("\n\n## **QC of reads before alignment**\n\n")
	cat("\n\n### **Total numbers of reads before and after trimming**\n\n")
	
	# look up these vars in the legend table using match
	vars_trimming_legend_names <- metric_var_2_legend_name[match(vars_trimming, metric_var_2_legend_name$metric_var), "legend_name" ]
	make_stacked_barchart_from_df_dodge(
		df = metric_table, 
        id = "sample", 
        other_vars = vars_trimming,
        legend_names = vars_trimming_legend_names
    )
```

.
```{r qual_scores, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_qual_scores}
	cat("\n\n### **Quality scores for samples - lowest scores (min/10th decile) and weighted average**\n\nThe weighted average is the weighted average  quality score per sequence. Other scores represent the minimum (10th percentile) score and average score per base")
	vars_qual_scores_legend_names <- metric_var_2_legend_name[match(vars_qual_scores, metric_var_2_legend_name$metric_var), "legend_name" ]
	make_vert_line_plot_from_df(
		df = metric_table, 
		id = "sample", 
		other_vars = vars_qual_scores,
		legend_names = vars_qual_scores_legend_names
	)
```


```{r aligned_v_qual, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_aligned_v_qual}
	##################################################
	###	RNASEQ PLOTS
	##################################################
	cat("\n\n### **Reads aligning to genes vs sequence quality scores**\n\nHere we plot the number of reads aligning to genomic features against the sequence quality scores")
	vars_aligned_v_qual_legend_names <- metric_var_2_legend_name[match(vars_aligned_v_qual, metric_var_2_legend_name$metric_var), "legend_name"]

    make_scatterplot_from_df(
		df = metric_table,
		var1 = vars_aligned_v_qual[1],
		var2 = vars_aligned_v_qual[2],
		axis_lab_name1 = vars_aligned_v_qual_legend_names[1],
		axis_lab_name2 = vars_aligned_v_qual_legend_names[2]
	)
```



```{r mapping, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_mapping}
	cat("\n\n## **Alignment Details**\n\n### **Trimmed reads mapping to the genome uniquely, non-uniquely, and not at all**\n\n")
	mapping_metric_table <- metric_table[, vars_mapping]
	mapping_metric_table <- sapply(mapping_metric_table, function(x) as.numeric(gsub("\\%", "", x)))
	mapping_metric_table <- data.frame(metric_table["sample"], mapping_metric_table)
	# Sum multimapping
	mapping_metric_table[, "multi_map"] <- mapping_metric_table[,"X._of_reads_mapped_to_multiple_loci"] + mapping_metric_table[,"X._of_reads_mapped_to_too_many_loci"]
	# Reselect table
	vars_mapping <- c("Uniquely_mapped_reads_.", "multi_map", "X._of_reads_unmapped._too_short", "X._of_reads_unmapped._other")
	mapping_metric_table <- mapping_metric_table[, vars_mapping]
	mapping_metric_table <- data.frame(metric_table["sample"], mapping_metric_table)

    vars_mapping_legend_names <- metric_var_2_legend_name[match(vars_mapping, metric_var_2_legend_name$metric_var), "legend_name" ]
    make_stacked_barchart_from_df(
		df = mapping_metric_table, 
        id = "sample", 
        other_vars = vars_mapping,
        legend_names = vars_mapping_legend_names
    )
```


```{r feature_overlap, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_feature_overlap}
	cat("\n\n### **Overlap of the mapped reads with genomic features**\n\n")
	vars_feature_overlap_legend_names <- metric_var_2_legend_name[match(vars_feature_overlap, metric_var_2_legend_name$metric_var), "legend_name" ]

    make_stacked_barchart_from_df_dodge(
		df = metric_table, 
        id = "sample", 
        other_vars = vars_feature_overlap,
        legend_names = vars_feature_overlap_legend_names
    )
```

```{r mirna_mapping, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_mirna_mapping}
	##################################################
	###	miRNASEQ PLOTS
	##################################################
	cat("\n\n## **Alignment Details**\n\n### **Trimmed reads mapping to the genome almost once, reads mapping suppresed by multimapping threshold, and not mapped at all**\n\n")
	mirna_mapping_metric_table <- metric_table[, vars_mirna_mapping]
	mirna_mapping_metric_table <- data.frame(metric_table["sample"], mirna_mapping_metric_table)
    vars_mirna_mapping_legend_names <- metric_var_2_legend_name[match(vars_mirna_mapping, metric_var_2_legend_name$metric_var), "legend_name" ]
    make_stacked_barchart_from_df(
		df = mirna_mapping_metric_table, 
        id = "sample", 
        other_vars = vars_mirna_mapping,
        legend_names = vars_mirna_mapping_legend_names
    )
```

```{r mirna_mapping_abs, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval=execute_mirna_mapping_abs}
	cat("\n\n### **Raw reads count mapping summary **\n\n")
	vars_mirna_mapping_abs_legend_names <- metric_var_2_legend_name[match(vars_mirna_mapping_abs, metric_var_2_legend_name$metric_var), "legend_name" ]

    make_stacked_barchart_from_df_dodge(
		df = metric_table, 
        id = "sample", 
        other_vars = vars_mirna_mapping_abs,
        legend_names = vars_mirna_mapping_abs_legend_names
    )
```
